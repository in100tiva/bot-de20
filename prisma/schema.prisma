// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de usuários/participantes
model User {
  id                    String            @id @default(cuid())
  discordId             String            @unique
  username              String
  points                Int               @default(0)
  streak                Int               @default(0)
  goDevsActivitiesCount Int               @default(0)  // Cache de atividades do GoDevs
  lastSyncedAt          DateTime?                      // Última sincronização com GoDevs
  lastActive            DateTime          @default(now())
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  badges                UserBadge[]
  goDevsActivities      GoDevsActivity[]
  
  @@map("users")
}

// Modelo de postagens diárias (registro de desafios enviados)
// Não usa foreign key - challengeId referencia o array local dailyChallenges
model DailyPost {
  id            String    @id @default(cuid())
  challengeId   Int       // ID do desafio no array dailyChallenges (sem FK)
  postedAt      DateTime  @default(now())
  channelId     String
  messageId     String
  
  @@map("daily_posts")
  @@index([challengeId])
  @@index([postedAt])
}

// Modelo de badges/conquistas
model Badge {
  id          String      @id @default(cuid())
  name        String      @unique
  description String
  icon        String
  requirement Int         // Número necessário para conquistar
  type        BadgeType
  createdAt   DateTime    @default(now())
  
  users       UserBadge[]
  
  @@map("badges")
}

// Relação usuário-badge (muitos para muitos)
model UserBadge {
  id         String   @id @default(cuid())
  userId     String
  badgeId    String
  earnedAt   DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@map("user_badges")
  @@index([userId])
}

// Modelo de atividades sincronizadas do GoDevs
model GoDevsActivity {
  id            String    @id @default(cuid())
  supabaseId    String    @unique                // ID original do Supabase
  userId        String
  activityName  String
  activityType  String    @default("CODING")     // CODING ou SEO
  submittedAt   DateTime
  syncedAt      DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("godevs_activities")
  @@index([userId])
  @@index([syncedAt])
}

// Modelo de desafios completados pelos usuários
model CompletedChallenge {
  id          String   @id @default(cuid())
  discordId   String                        // Discord ID do usuário
  challengeId Int                           // ID do desafio no array dailyChallenges
  completedAt DateTime @default(now())
  messageUrl  String?                       // Link da mensagem de entrega
  
  @@unique([discordId, challengeId])
  @@map("completed_challenges")
  @@index([discordId])
  @@index([challengeId])
}

// Enums
enum BadgeType {
  PARTICIPATION  // Por número de desafios
  STREAK         // Por dias consecutivos
  SPECIAL        // Conquistas especiais
  ACHIEVEMENT    // Conquistas gerais
}

